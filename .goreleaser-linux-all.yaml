version: 2
project_name: musicalc

before:
  hooks:
    - git pull && git checkout -- go.mod && git fetch --tags --force
#    - go mod tidy

builds:
  - id: linux-amd64
    env:
      - CGO_ENABLED=1
      - CGO_CFLAGS=-O3 -flto=auto -march=x86-64-v3
      - CGO_LDFLAGS=-O3 -flto=auto
      - CC=gcc
      - CXX=g++
    goos:
      - linux
    goarch:
      - amd64
    goamd64: [v3]
    ldflags:
      - -s -w

  - id: linux-arm64
    env:
      - CGO_ENABLED=1
      - CC=aarch64-linux-gnu-gcc
      - PKG_CONFIG_PATH=/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig
      - CGO_CFLAGS=-O3 -flto=auto -march=armv8.4-a+crc+crypto -fomit-frame-pointer
      - CGO_LDFLAGS=-O3 -flto=auto -Wl,--gc-sections
    goos:
      - linux
    goarch:
      - arm64
    ldflags:
      - -s -w      
  
# This creates the .tar.gz bundle
archives:
  - files:
      - src: "install.sh"
      - src: "icons/appicon.png"
        dst: "icon.png"
      - src: "musicalc.desktop"

# This creates the .deb and .rpm "Installers"
nfpms:
  - file_name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Arch }}"
    homepage: https://github.com/bzeiss/musicalc
    maintainer: B. Zeiss <ben@zeiss.net>
    description: Music Calculator Utility
    formats:
      - deb
      - rpm
    
    # This tells Linux where to put the files on the user's system
    contents:
      - src: icons/appicon.png
        dst: /usr/share/icons/hicolor/512x512/apps/musicalc.png
      
      # This creates the Start Menu entry automatically (uses /usr/bin path)
      - src: musicalc-pkg.desktop
        dst: /usr/share/applications/musicalc.desktop
        type: config